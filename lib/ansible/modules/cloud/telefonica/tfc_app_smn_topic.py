#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# Copyright (C) 2018 Huawei
# GNU General Public License v3.0+ (see COPYING or
# https://www.gnu.org/licenses/gpl-3.0.txt)
# ----------------------------------------------------------------------------
#
#     ***     AUTO GENERATED CODE    ***    AUTO GENERATED CODE     ***
#
# ----------------------------------------------------------------------------
#
#     This file is automatically generated by Magic Modules and manual
#     changes will be clobbered when the file is regenerated.
#
#     Please read more about how to change this file at
#     https://www.github.com/huaweicloud/magic-modules
#
# ----------------------------------------------------------------------------

from __future__ import absolute_import, division, print_function
__metaclass__ = type

###############################################################################
# Documentation
###############################################################################

ANSIBLE_METADATA = {'metadata_version': '1.1',
                    'status': ["preview"],
                    'supported_by': 'community'}

DOCUMENTATION = '''
---
module: tfc_app_smn_topic
description:
    - Represents a SMN notification topic resource.
short_description: Creates a resource of SMNTopic in Telefonica Cloud
version_added: 2.7
author: Huawei Inc. (@huaweicloud)
requirements:
    - python >= 2.6
    - requests >= 2.18.4
    - keystoneauth1 >= 3.6.0
options:
    state:
        description:
            - Whether the given object should exist in Telefonica Cloud.
        choices: ['present', 'absent']
        default: 'present'
    display_name:
        description:
            - Topic display name, which is presented as the name of the email
              sender in an email message. The topic display name contains a
              maximum of 192 bytes.
        required: false
    name:
        description:
            - Name of the topic to be created. The topic name is a string of 1
              to 256 characters. It must contain upper- or lower-case letters,
              digits, hyphens (-), and underscores C(_), and must start with a
              letter or digit.
        required: true
extends_documentation_fragment: hwc
'''

EXAMPLES = '''
- name: create a smn topic
  tfc_app_smn_topic:
      identity_endpoint: "{{ identity_endpoint }}"
      user_name: "{{ user_name }}"
      password: "{{ password }}"
      domain_name: "{{ domain_name }}"
      project_name: "{{ project_name }}"
      region: "{{ region }}"
      name: "ansible_app_smn_topic_test"
      state: present
'''

RETURN = '''
    create_time:
        description:
            - Time when the topic was created.
        returned: success
        type: str
    display_name:
        description:
            - Topic display name, which is presented as the name of the email
              sender in an email message. The topic display name contains a
              maximum of 192 bytes.
        returned: success
        type: str
    name:
        description:
            - Name of the topic to be created. The topic name is a string of 1
              to 256 characters. It must contain upper- or lower-case letters,
              digits, hyphens (-), and underscores C(_), and must start with a
              letter or digit.
        returned: success
        type: str
    push_policy:
        description:
            - Message pushing policy. 0 indicates that the message sending
              fails and the message is cached in the queue. 1 indicates that
              the failed message is discarded.
        returned: success
        type: int
    topic_urn:
        description:
            - Resource identifier of a topic, which is unique.
        returned: success
        type: str
    update_time:
        description:
            - Time when the topic was updated.
        returned: success
        type: str
'''

###############################################################################
# Imports
###############################################################################

from ansible.module_utils.hwc_utils import (HwcSession, HwcModule,
                                            DictComparison, navigate_hash,
                                            remove_nones_from_dict,
                                            remove_empty_from_dict,
                                            HwcClientException,
                                            HwcClientException404)
import json
import re

###############################################################################
# Main
###############################################################################


def main():
    """Main function"""

    module = HwcModule(
        argument_spec=dict(
            state=dict(default='present', choices=['present', 'absent'],
                       type='str'),
            display_name=dict(type='str'),
            name=dict(required=True, type='str')
        )
    )
    try:
        session = HwcSession(module, "app")
    except HwcClientException as ex:
        module.fail_json(msg=str(ex))

    state = module.params['state']

    if not module.params.get("id"):
        module.params['id'] = get_resource_id(session)

    fetch = get_resource(session)
    changed = False

    if fetch:
        if state == 'present':
            expect = _get_resource_editable_properties(module)
            current_state = response_to_hash(module, fetch)
            if is_different(expect, current_state):
                fetch = update(session)
                fetch = response_to_hash(module, fetch)
                changed = True
            else:
                fetch = current_state
        else:
            delete(session)
            fetch = {}
            changed = True
    else:
        if state == 'present':
            fetch = create(session)
            fetch = response_to_hash(module, fetch)
            changed = True
        else:
            fetch = {}

    fetch.update({'changed': changed})

    module.exit_json(**fetch)


def create(session):
    link = collection(session)
    module = session.module
    try:
        r = session.post(link, resource_to_create(module))
    except HwcClientException as ex:
        module.fail_json(msg=str(ex))
    module.params['id'] = r.get('topic_urn', None)

    v = get_resource(session)
    if v:
        r.update(v)
    return r


def update(session):
    link = self_link(session)
    module = session.module
    try:
        session.put(link, resource_to_update(module))
    except HwcClientException as ex:
        module.fail_json(msg=str(ex))

    return get_resource(session)


def delete(session):
    link = self_link(session)
    try:
        session.delete(link)
    except HwcClientException as ex:
        session.module.fail_json(msg=str(ex))


def get_resource(session):
    link = self_link(session)
    # the link will include Nones if required format parameters are missed
    if re.search('/None/|/None$', link):
        return None

    try:
        return session.get(link)
    except HwcClientException404:
        return None
    except HwcClientException as ex:
        session.module.fail_json(msg=str(ex))


def link_wrapper(f):
    def _wrapper(session, *args, **kwargs):
        try:
            return f(session, *args, **kwargs)
        except KeyError as ex:
            session.module.fail_json(
                msg="Mapping keys(%s) are not found in generating link" % ex)

    return _wrapper


def get_resource_id(session):
    module = session.module
    link = list_link(session, {'limit': 10, 'offset': '{offset}'})
    p = {'offset': 0}
    v = module.params.get('name')
    ids = set()
    while True:
        try:
            r = session.get(link.format(**p))
        except HwcClientException404:
            break
        except HwcClientException as ex:
            module.fail_json(msg=str(ex))
        if r is None:
            break
        r = r.get('topics', [])
        if r == []:
            break
        for i in r:
            if i.get('name') == v:
                ids.add(i.get('topic_urn'))
        if len(ids) >= 2:
            module.fail_json(msg="Multiple resources are found")

        p['offset'] += 1

    return ids.pop() if ids else None


@link_wrapper
def list_link(session, extra_data=None):
    url = "{endpoint}notifications/topics?limit={limit}&offset={offset}"

    combined = session.module.params.copy()
    if extra_data:
        combined.update(extra_data)

    try:
        e = session.get_service_endpoint('compute')
        combined['endpoint'] = e.replace("ecs", "smn")
    except HwcClientException as ex:
        session.module.fail_json(msg=str(ex))

    return url.format(**combined)


@link_wrapper
def self_link(session):
    url = "{endpoint}notifications/topics/{id}"

    combined = session.module.params.copy()

    try:
        e = session.get_service_endpoint('compute')
        combined['endpoint'] = e.replace("ecs", "smn")
    except HwcClientException as ex:
        session.module.fail_json(msg=str(ex))

    return url.format(**combined)


@link_wrapper
def collection(session):
    url = "{endpoint}notifications/topics"

    combined = session.module.params.copy()

    try:
        e = session.get_service_endpoint('compute')
        combined['endpoint'] = e.replace("ecs", "smn")
    except HwcClientException as ex:
        session.module.fail_json(msg=str(ex))

    return url.format(**combined)




def is_different(expect, actual):
    # Remove all output-only from actual.
    actual_vals = {}
    for k, v in actual.items():
        if k in expect:
            actual_vals[k] = v

    expect_vals = {}
    for k, v in expect.items():
        if k in actual:
            expect_vals[k] = v

    return DictComparison(expect_vals) != DictComparison(actual_vals)


def resource_to_create(module):
    request = remove_empty_from_dict({
        u'display_name': module.params.get('display_name'),
        u'name': module.params.get('name')
    })
    return request


def resource_to_update(module):
    request = remove_nones_from_dict({
        u'display_name': module.params.get('display_name')
    })
    return request


def _get_resource_editable_properties(module):
    return remove_nones_from_dict({
        "display_name": module.params.get("display_name"),
    })


# Remove unnecessary properties from the response.
# This is for doing comparisons with Ansible's current parameters.
def response_to_hash(module, response):
    return {
        u'create_time': response.get(u'create_time'),
        u'display_name': response.get(u'display_name'),
        u'name': response.get(u'name'),
        u'push_policy': _push_policy_convert_from_response(
            response.get('push_policy')),
        u'topic_urn': response.get(u'topic_urn'),
        u'update_time': response.get(u'update_time')
    }


def _push_policy_convert_from_response(value):
    return {
        0: "the message sending fails and is cached in the queue",
        1: "the failed message is discarded",
    }.get(int(value))


if __name__ == '__main__':
    main()
